namespace = fi_dividend_collector

fi_dividend_collector.1 = {
	type = country_event
	hidden = yes

	trigger = {
		has_variable = fi_identification
	}

	immediate = {
		save_scope_as = fi_target_country
		fi_id_building_executor = {
			FUNCTION = collect_investment_dividend
		}
		
		set_variable = {
			name = dividend_collect_sum
			value = 0
		}
		every_country = {
			limit = {
				has_variable = fi_dividend_sum_total
				var:fi_dividend_sum_total > 0
			}
			set_local_variable = {
				name = fi_modifier_mult
				value = var:fi_dividend_sum_total
			}
			change_local_variable = {
				name = fi_modifier_mult
				multiply = country_gdp_dividend_penalty_cancel
			}
			add_modifier = {
				name = investment_dividend_payment
				multiplier = local_var:fi_modifier_mult
				days = 30
			}
			root = {
				change_variable = {
					name = dividend_collect_sum
					add = local_var:fi_modifier_mult
				}
			}
			remove_local_variable = fi_modifier_mult
			remove_variable = fi_dividend_sum_total
		}
		if = {
			limit = {
				has_variable = total_invested_building
				NOT = {
					any_scope_building = {
						is_building_type = building_investment_industry
					}
				}
			}
			market_capital = {
				create_building_effect = {
					BUILDING_TYPE = building_investment_industry
				}
			}
		}
		if = {
			limit = {
				NOT = { market_capital = { owner = root } }
			}
			trigger_event = { id = fi_dividend_collector.2 }
		}
		every_scope_building = {
			limit = {
				is_building_type = building_investment_industry
			}
			state = {
				if = {
					limit = {
						NOT = { root.market_capital = this }
					}
					remove_building = building_investment_industry
				}
			}
			root = {
				if = {
					limit = {
						prev.level < 1000
						has_variable = total_invested_building
						prev.level < var:total_invested_building
					}
					while = {
						limit = {
							has_variable = total_invested_building
							prev.level < var:total_invested_building
						}
						market_capital = {
							create_building_effect = {
								BUILDING_TYPE = building_investment_industry
							}
						}
					}
				}
				if = {
					limit = {
						prev.level < 1000
						has_variable = total_invested_building
						prev.level > var:total_invested_building
					}
					cancel_building_effect = yes
				}
				change_variable = {
					name = dividend_collect_sum
					divide = prev.level
				}
				change_variable = {
					name = dividend_collect_sum
					divide = prev.occupancy
				}
				change_variable = {
					name = dividend_collect_sum
					divide = 200
				}
				change_variable = {
					name = dividend_collect_sum
					subtract = 1
				}
			}
			
			remove_modifier = investment_dividend_paid
			add_modifier = {
				name = investment_dividend_paid
				multiplier = root.var:dividend_collect_sum
			}
		}
		
		remove_variable = dividend_collect_sum
	}
}

fi_dividend_collector.2 = {
	type = country_event
	duration = 3
	title = fi_dividend_collector.2.t
	desc = fi_dividend_collector.2.d
	flavor = fi_dividend_collector.2.f

	event_image = {
		video = "unspecific_vandalized_storefront"
	}

	on_created_soundeffect = "event:/SFX/UI/Alerts/event_appear"

	icon = "gfx/interface/icons/event_icons/event_trade.dds"

	trigger = {
		any_scope_building = {
			is_building_type = building_investment_industry
		}
		
		NOT = {
			market_capital = { owner = root }
		}
	}

	immediate = {
		every_scope_state = {
			limit = {
				has_building = building_investment_industry
			}
			remove_building = building_investment_industry
		}
		save_scope_as = fi_target_country
		fi_id_building_executor = {
			FUNCTION = cancel_queued_construction
		}
		
		if = {
			limit = {
				any_country = {
					has_variable = mine_exclusive
					var:mine_exclusive = root.var:fi_identification
				}
			}
			random_country = {
				limit = {
					has_variable = mine_exclusive
					var:mine_exclusive = root.var:fi_identification
				}
				remove_variable = mine_exclusive
				remove_modifier = mine_exclusive_right
			}
		}
		if = {
			limit = {
				has_variable = total_invested_building
				var:total_invested_building > 0
			}
			save_scope_as = investor_country
			every_state = {
				limit = {
					NOT = {	owner = root }
				}
				fi_id_remove_all_from_state_country = yes
			}
		}
		remove_variable = fi_identification
		remove_variable = total_invested_building

	}
	option = { 
		name = fi_dividend_collector.2.a
		default_option = yes
		add_radicals = {
			value = small_radicals
			strata = rich
		}
		custom_tooltip = {
			text = fi_market_collapse
		}
	}
}

fi_dividend_collector.3 = {
	type = country_event
	duration = 3
	title = fi_dividend_collector.3.t
	desc = fi_dividend_collector.3.d
	flavor = fi_dividend_collector.3.f

	event_image = {
		video = "gfx/event_pictures/middleeast_police_breaking_door.bk2"
	}

	on_created_soundeffect = "event:/SFX/UI/Alerts/event_appear"
	on_opened_soundeffect = "event:/SFX/Events/middleeast/police_breaking_door"

	icon = "gfx/interface/icons/event_icons/event_protest.dds"

	trigger = {
	}

	immediate = {
		random_state = {
			limit = {
				has_variable = destroyed_building_state
				NOT = { owner = root }
			}
			save_scope_as = destroyed_building_state
			set_local_variable = {
				name = destroyed_number_store
				value = var:destroyed_building_state
			}
			remove_variable = destroyed_building_state
			owner = {
				save_scope_as = destroyed_building_country
			}
		}
	}
	
	option = { 
		name = fi_dividend_collector.3.a
		default_option = yes
		add_loyalists = {
			value = small_radicals
			strata = rich
		}
		if = {
			limit = {
				scope:destroyed_building_country = {
					OR = {
						NOT = { has_variable = mine_exclusive }
						var:mine_exclusive = root.var:fi_identification
					}
				}
			}
			scope:destroyed_building_state.state_region = {
				add_claim = root
			}
		}
		set_variable = investor_country
		scope:destroyed_building_country = {
			change_infamy = destroyed_total_number_capped_10
			change_relations = {
				country = root
				value = destroyed_total_number_capped_10_times_3
			}
			remove_local_variable = destroyed_number_store
			hidden_effect = { trigger_event = { id = fi_share_taking_executer.3 } }
		}
		ai_chance = {base = 9}
	}

	option = { 
		name = fi_dividend_collector.3.b
		add_radicals = {
			value = small_radicals
			strata = rich
		}
		remove_local_variable = destroyed_number_store
		ai_chance = {base = 1}
	}
}


fi_dividend_collector.4 = {
	type = country_event
	hidden = yes

	trigger = {
	}

	immediate = {
		save_scope_as = fi_target_country
		fi_id_building_executor = {
			FUNCTION = cancel_queued_construction
		}
	}
}

fi_dividend_collector.5 = {
	type = country_event
	hidden = yes

	trigger = {
		has_variable = fi_identification
	}

	immediate = {
		clear_variable_list = invested_states
		root = { save_scope_as = investor_country }
		every_state = {
			fi_add_list = yes
		}
	}
}

fi_dividend_collector.6 = {
	type = country_event
	hidden = yes

	trigger = {
		has_variable = fi_identification
		has_variable = number_of_foreign_construction
		market_capital = {
			OR = {
				NOT = {
					any_scope_building = {
						is_building_group = bg_investment_industry
					}
				}
				NOT = {
					any_scope_building = {
						is_building_group = bg_investment_industry
						is_under_construction = yes
					}
				}
			}
		}
	}

	immediate = {
		if = {
			limit = {
				has_variable = fi_identification
				has_variable = number_of_foreign_construction
				OR = {
					NOT = {
						any_scope_building = {
							is_building_group = bg_investment_industry
						}
					}
					NOT = {
						any_scope_building = {
							is_building_group = bg_investment_industry
							is_under_construction = yes
						}
					}
				}
			}
			trigger_event = { id = fi_dividend_collector.4 }
		}
	}
}
